---
title: Hello, Bach.
date: April 24, 2024
---

```{r echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

```{r echo=FALSE}

Sys.setenv(RETICULATE_PYTHON = "/Users/charles/Documents/digmus/digmusenv/bin/python")
# reticulate::py_config()

```

```{r message=FALSE}
# general datasci toolkit packages
library(tidyverse) # grabbag of datasci tools
library(gt) # for tables
library(pyramidi)

```

# Objective

Animate the *subject* of J. S. Bach's Contrapunctus I as a directed graph using `ggraph`.

The biggest learning curve here is going to be the data export of music; I'm exploring how to produce live animation, but need to break this into a series of small, achievable objectives. The live component will come last, to begin with I need to figure out how to export the data from what I play into something I can understand as data. 

Another quite separate hurdle is to explore expanding my compositions from acoustic to production-infused neoclassical I've always heard in my head. To get started, however, I will use Bach for developing my animation ideas.

# Contrapunctus I

Contrapunctus I is a particularly nice piece of music for this task. It is the opening work of Bach's [*The Art of Fugue*](https://en.wikipedia.org/wiki/The_Art_of_Fugue), and follows a very specific musical structure that Bach was pivotal in developing. 

A *fugue* is a work of polyphonic (melodies that produce vertical harmonies through overlay) that develops a *subject*, a short melodic motif. 

Here is the subject of Contrapunctus I, the focus of this animation project.

![](https://upload.wikimedia.org/score/k/u/kuqreev9vn17n29y7rcsbjjw752x7we/kuqreev9.png)


# Midi to data

```{r }
mfr <- MidiFramer$new('../midi/wikisource-contrapunctus-subject.midi')

```

```{r}
mididat <- mfr$df_notes_long |> select(note, b) |> distinct()

# set the D minor scale 
d_minor <- c('D', 'E', 'F', 'G', 'A', 'Bb', 'C#')

# set the midi number notes for joining 
note <- c(62, 64, 65, 67, 69, 70, 61)

d_minor <- tibble(d_minor, note)

subject_dat <- mididat |>
    left_join(d_minor, by = 'note') |>
    mutate(step = rep.int(c('start', 'stop'), times = 12), 
        index = rep(seq(1, 12), each = 2)) |>
        pivot_wider(names_from = step, values_from = b) |>   
    mutate(
        note = as.integer(note),
        b = start,
        start = as.integer(round(start)),
        stop = as.integer(round(stop)),
        bar = start %/% 16 + 1,
        bar = as.integer(bar),
        duration = stop - start
    ) |>
    select(d_minor, note, start, duration, bar, b) 

write_csv(subject_dat, '../mididat.csv')

gtfirsttry <- 
subject_dat |> gt() |>
    tab_header(md('![](https://upload.wikimedia.org/score/k/u/kuqreev9vn17n29y7rcsbjjw752x7we/kuqreev9.png)'))

gtsave(gtfirsttry, 'firsttrytab.png')

```

# ggraph data structure

Â 